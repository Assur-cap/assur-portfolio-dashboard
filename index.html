<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assur Capital â€” Portfolio Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg-primary:    #07070e;
  --bg-secondary:  #0d0d1a;
  --bg-card:       #111122;
  --bg-card2:      #0e0e1c;
  --border:        #1e1e35;
  --border-bright: #2a2a50;
  --text-primary:  #e2e8f0;
  --text-secondary:#8892a4;
  --text-muted:    #4a5568;
  --accent-blue:   #3b82f6;
  --accent-cyan:   #06b6d4;
  --accent-green:  #10b981;
  --accent-red:    #ef4444;
  --accent-orange: #f59e0b;
  --accent-purple: #8b5cf6;
  --accent-pink:   #ec4899;
  --mono: 'JetBrains Mono', 'Courier New', monospace;
  --sans: 'Space Grotesk', system-ui, sans-serif;
  --card-radius: 8px;
  --glow-blue: 0 0 20px rgba(59,130,246,0.15);
  --glow-cyan: 0 0 20px rgba(6,182,212,0.15);
}

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--sans);
  height: 100vh;
  display: flex;
  overflow: hidden;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }

/* SIDEBAR */
.sidebar {
  width: 220px;
  min-width: 220px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  z-index: 100;
}

.sidebar-logo {
  padding: 20px 18px 14px;
  border-bottom: 1px solid var(--border);
}

.sidebar-logo .logo-title {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 2px;
  color: var(--accent-cyan);
  text-transform: uppercase;
}

.sidebar-logo .logo-sub {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 3px;
  letter-spacing: 1px;
}

.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(16,185,129,0.12);
  border: 1px solid rgba(16,185,129,0.3);
  border-radius: 4px;
  padding: 2px 6px;
  margin-top: 8px;
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 600;
  color: var(--accent-green);
  letter-spacing: 1px;
}

.live-badge.stale {
  background: rgba(245,158,11,0.12);
  border-color: rgba(245,158,11,0.3);
  color: var(--accent-orange);
}

.live-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent-green);
  animation: pulse-green 2s ease-in-out infinite;
}

.live-badge.stale .live-dot {
  background: var(--accent-orange);
  animation: none;
}

@keyframes pulse-green {
  0%,100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16,185,129,0.4); }
  50%      { opacity: 0.7; box-shadow: 0 0 0 4px rgba(16,185,129,0); }
}

.sidebar-nav { padding: 12px 0; flex: 1; }

.nav-label {
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  text-transform: uppercase;
  padding: 10px 18px 4px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 18px;
  cursor: pointer;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-secondary);
  border-left: 2px solid transparent;
  transition: all 0.15s;
  text-decoration: none;
  white-space: nowrap;
}

.nav-item:hover { background: rgba(6,182,212,0.06); color: var(--text-primary); }
.nav-item.active { background: rgba(6,182,212,0.1); color: var(--accent-cyan); border-left-color: var(--accent-cyan); }
.nav-item .nav-icon { font-size: 12px; width: 16px; text-align: center; }

.sidebar-footer {
  padding: 12px 18px;
  border-top: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-muted);
  line-height: 1.6;
}

.ts-line { margin-top: 3px; font-size: 8px; }

/* MAIN CONTENT */
.main {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}

.section {
  padding: 32px 28px;
  min-height: 100vh;
  border-bottom: 1px solid var(--border);
}

.section:last-child { border-bottom: none; }

.section-header {
  display: flex;
  align-items: baseline;
  gap: 12px;
  margin-bottom: 24px;
}

.section-title {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-primary);
}

.section-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 1px;
}

/* LOADING SKELETON */
#loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg-primary);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
  transition: opacity 0.5s ease;
}

#loading-overlay.hidden { opacity: 0; pointer-events: none; }

.loader-logo {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 3px;
  color: var(--accent-cyan);
}

.loader-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 2px;
}

.loader-bar-track {
  width: 260px;
  height: 2px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.loader-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
  border-radius: 2px;
  animation: load-bar 1.8s ease-in-out infinite;
}

@keyframes load-bar {
  0%   { width: 0%;   margin-left: 0%; }
  50%  { width: 60%;  margin-left: 20%; }
  100% { width: 0%;   margin-left: 100%; }
}

.loader-status {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-muted);
  min-height: 16px;
}

/* ERROR BANNER */
.stale-banner {
  display: none;
  background: rgba(245,158,11,0.08);
  border: 1px solid rgba(245,158,11,0.3);
  border-radius: 6px;
  padding: 8px 14px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--accent-orange);
  margin-bottom: 20px;
  align-items: center;
  gap: 8px;
}
.stale-banner.visible { display: flex; }

/* CARDS & GRIDS */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--card-radius);
  padding: 20px;
}

.card-sm { padding: 16px; }

.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }

/* STAT CARDS */
.stat-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 6px;
}

.stat-value {
  font-family: var(--mono);
  font-size: 22px;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: -0.5px;
}

.stat-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.stat-change {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  padding: 2px 6px;
  border-radius: 4px;
  margin-top: 6px;
}

.pos { color: var(--accent-green); background: rgba(16,185,129,0.1); }
.neg { color: var(--accent-red);   background: rgba(239,68,68,0.1); }
.neu { color: var(--text-secondary); background: rgba(136,146,164,0.1); }

/* HOLDINGS TABLE */
.table-wrapper { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--mono);
  font-size: 12px;
}

thead th {
  padding: 8px 12px;
  text-align: left;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

thead th.right { text-align: right; }

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}

tbody tr:hover { background: rgba(255,255,255,0.02); }
tbody tr:last-child { border-bottom: none; }

tbody td {
  padding: 10px 12px;
  white-space: nowrap;
}

tbody td.right { text-align: right; }

.ticker-badge {
  display: inline-block;
  background: rgba(59,130,246,0.12);
  border: 1px solid rgba(59,130,246,0.25);
  color: var(--accent-blue);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.ticker-badge.crypto {
  background: rgba(6,182,212,0.12);
  border-color: rgba(6,182,212,0.25);
  color: var(--accent-cyan);
}

.bar-cell { display: flex; align-items: center; gap: 8px; }
.weight-bar {
  height: 4px;
  background: var(--accent-blue);
  border-radius: 2px;
  min-width: 2px;
  transition: width 0.3s ease;
}

/* CHARTS */
.chart-wrapper { position: relative; }

/* CORRELATION HEATMAP */
.corr-grid {
  display: grid;
  gap: 2px;
  font-family: var(--mono);
  font-size: 9px;
}

.corr-cell {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 3px;
  cursor: default;
  font-size: 8px;
  font-weight: 500;
  transition: transform 0.1s;
}

.corr-cell:hover { transform: scale(1.1); z-index: 2; }

/* RISK METRICS */
.metric-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 12px;
}
.metric-row:last-child { border-bottom: none; }
.metric-name { color: var(--text-secondary); font-size: 11px; }
.metric-val  { color: var(--text-primary); font-weight: 500; }
.metric-tag  { font-size: 9px; padding: 2px 5px; border-radius: 3px; margin-left: 8px; }
.tag-warn    { background: rgba(239,68,68,0.12); color: var(--accent-red); }
.tag-ok      { background: rgba(16,185,129,0.12); color: var(--accent-green); }
.tag-neutral { background: rgba(59,130,246,0.12); color: var(--accent-blue); }

/* STRESS TESTS */
.stress-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--card-radius);
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.stress-change { font-family: var(--mono); font-size: 20px; font-weight: 600; }

/* FUNDAMENTALS */
.fund-select {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 5px;
  color: var(--text-primary);
  font-family: var(--mono);
  font-size: 11px;
  padding: 6px 10px;
  outline: none;
  cursor: pointer;
}

/* REBALANCING */
.rebal-row {
  display: grid;
  grid-template-columns: 80px 1fr 80px 80px;
  align-items: center;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 11px;
}
.rebal-row:last-child { border-bottom: none; }

.rebal-bars { display: flex; flex-direction: column; gap: 4px; }
.rebal-bar-row { display: flex; align-items: center; gap: 6px; font-size: 9px; color: var(--text-muted); }
.rebal-bar-track { flex: 1; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.rebal-bar-fill  { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
.bar-current { background: var(--accent-blue); }
.bar-erc     { background: var(--accent-green); }
.bar-div     { background: var(--accent-orange); }

/* YIELD CURVE */
.yield-select {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 5px;
  color: var(--text-primary);
  font-family: var(--mono);
  font-size: 11px;
  padding: 6px 10px;
  outline: none;
  cursor: pointer;
}

/* INCOME */
.income-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 12px;
}
.income-row:last-child { border-bottom: none; }

/* SKELETON PULSAR */
.skel {
  background: linear-gradient(90deg, var(--bg-card) 25%, var(--border) 50%, var(--bg-card) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
}

@keyframes shimmer {
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* MOBILE */
.hamburger {
  display: none;
  position: fixed;
  top: 12px; left: 12px;
  z-index: 200;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 16px;
}

@media (max-width: 768px) {
  .hamburger { display: block; }
  .sidebar {
    position: fixed;
    left: -220px;
    height: 100vh;
    transition: left 0.3s;
    z-index: 150;
  }
  .sidebar.open { left: 0; }
  .section { padding: 20px 14px; }
  .grid-4 { grid-template-columns: repeat(2, 1fr); }
  .grid-3 { grid-template-columns: 1fr; }
}

/* MISC */
.tag {
  display: inline-block;
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 3px;
  letter-spacing: 0.5px;
}

.divider {
  height: 1px;
  background: var(--border);
  margin: 20px 0;
}

canvas { max-width: 100%; }

.chart-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 12px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-secondary);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 2px;
}

.section-note {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 14px;
  padding: 8px 12px;
  background: var(--bg-card2);
  border-left: 2px solid var(--border-bright);
  border-radius: 0 4px 4px 0;
}

.big-number {
  font-family: var(--mono);
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -1px;
}

.inline-price-change {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-family: var(--mono);
  font-size: 11px;
  margin-left: 8px;
}

h3.card-title {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 14px;
}

.sub-note {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-muted);
  margin-top: 6px;
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="loader-logo">ASSUR CAPITAL</div>
  <div class="loader-sub">PORTFOLIO TERMINAL v2.0</div>
  <div class="loader-bar-track"><div class="loader-bar"></div></div>
  <div class="loader-status" id="loader-status">Initializing...</div>
</div>

<!-- Mobile hamburger -->
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-title">ASSUR CAPITAL</div>
    <div class="logo-sub">PORTFOLIO TERMINAL v2.0 - LIVE</div>
    <div class="live-badge" id="live-badge"><span class="live-dot"></span><span id="live-badge-text">LIVE</span></div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-label">Portfolio</div>
    <a class="nav-item active" href="javascript:void(0)" data-section="overview" onclick="navTo('overview')">
      <span class="nav-icon">Overview</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="allocation" onclick="navTo('allocation')">
      <span class="nav-icon">Allocation</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="holdings" onclick="navTo('holdings')">
      <span class="nav-icon">Holdings</span>
    </a>
    <div class="nav-label">Analytics</div>
    <a class="nav-item" href="javascript:void(0)" data-section="correlation" onclick="navTo('correlation')">
      <span class="nav-icon">Correlation</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="risk" onclick="navTo('risk')">
      <span class="nav-icon">Risk Metrics</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="performance" onclick="navTo('performance')">
      <span class="nav-icon">Performance</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="montecarlo" onclick="navTo('montecarlo')">
      <span class="nav-icon">Monte Carlo</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="stress" onclick="navTo('stress')">
      <span class="nav-icon">Stress Tests</span>
    </a>
    <div class="nav-label">Market Data</div>
    <a class="nav-item" href="javascript:void(0)" data-section="fundamentals" onclick="navTo('fundamentals')">
      <span class="nav-icon">Fundamentals</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="yield" onclick="navTo('yield')">
      <span class="nav-icon">Yield Curve</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="rebalancing" onclick="navTo('rebalancing')">
      <span class="nav-icon">Rebalancing</span>
    </a>
    <a class="nav-item" href="javascript:void(0)" data-section="income" onclick="navTo('income')">
      <span class="nav-icon">Income</span>
    </a>
  </nav>
  <div class="sidebar-footer" id="sidebar-footer">
    <div id="ts-analytics">Analytics: -</div>
    <div class="ts-line" id="ts-prices">Prices: -</div>
    <div class="ts-line" id="ts-refresh">Next refresh: 5m</div>
  </div>
</aside>

<!-- MAIN CONTENT -->
<main class="main" id="main-content">

  <!-- OVERVIEW -->
  <section class="section" id="overview">
    <div class="section-header">
      <span class="section-title">Overview</span>
      <span class="section-sub" id="overview-updated">-</span>
    </div>
    <div id="stale-banner" class="stale-banner">
      <span>Warning</span>
      <span id="stale-msg">Live quotes unavailable - showing cached prices. Data may be stale.</span>
    </div>
    <div class="grid-4" style="margin-bottom:16px">
      <div class="card">
        <div class="stat-label">Total Value</div>
        <div class="stat-value big-number" id="stat-total-value">-</div>
        <div class="stat-sub" id="stat-invested">Invested: -</div>
        <div class="stat-change" id="stat-total-return">-</div>
      </div>
      <div class="card">
        <div class="stat-label">Daily P&amp;L</div>
        <div class="stat-value" id="stat-daily-pnl">-</div>
        <div class="stat-sub" id="stat-daily-pct">-</div>
        <div class="stat-sub" style="margin-top:6px;font-size:9px;color:var(--text-muted)">Today change</div>
      </div>
      <div class="card">
        <div class="stat-label">Portfolio Return (1Y)</div>
        <div class="stat-value" id="stat-1y-return">-4.42%</div>
        <div class="stat-sub">vs SPY: <span id="stat-spy-return" style="color:var(--accent-red)">-8.67%</span></div>
        <div class="stat-change pos" style="margin-top:6px">+4.25pp alpha</div>
      </div>
      <div class="card">
        <div class="stat-label">Cash</div>
        <div class="stat-value">$50,000</div>
        <div class="stat-sub" id="stat-cash-weight">Weight: -</div>
        <div class="stat-sub" style="margin-top:4px;font-size:9px;color:var(--text-muted)">17.6% of portfolio</div>
      </div>
    </div>
    <div class="grid-3">
      <div class="card">
        <h3 class="card-title">Risk Summary</h3>
        <div class="metric-row">
          <span class="metric-name">Ann. Volatility</span>
          <span class="metric-val">20.28%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Sharpe Ratio</span>
          <span class="metric-val">-0.415 <span class="metric-tag tag-warn">WEAK</span></span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Max Drawdown</span>
          <span class="metric-val" style="color:var(--accent-red)">-33.83%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Beta (vs SPY)</span>
          <span class="metric-val">0.649 <span class="metric-tag tag-ok">LOW</span></span>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">Value at Risk</h3>
        <div class="metric-row">
          <span class="metric-name">VaR 95% (1-day %)</span>
          <span class="metric-val" style="color:var(--accent-red)">-1.78%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 95% ($)</span>
          <span class="metric-val" id="var95-dollar">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 99% (1-day %)</span>
          <span class="metric-val" style="color:var(--accent-red)">-3.37%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 99% ($)</span>
          <span class="metric-val" id="var99-dollar">-</span>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">Concentration</h3>
        <div class="metric-row">
          <span class="metric-name">HHI Index</span>
          <span class="metric-val">0.3646 <span class="metric-tag tag-warn">HIGH</span></span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Top Holding</span>
          <span class="metric-val">BTC 55.7%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Top 3 Holdings</span>
          <span class="metric-val">BTC+NU+TSLA</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Ann. Return</span>
          <span class="metric-val" style="color:var(--accent-red)">-4.42%</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ALLOCATION -->
  <section class="section" id="allocation">
    <div class="section-header">
      <span class="section-title">Allocation</span>
      <span class="section-sub">Asset class Sector Geography</span>
    </div>
    <div class="grid-3">
      <div class="card">
        <h3 class="card-title">By Asset Class</h3>
        <div class="chart-wrapper" style="height:200px">
          <canvas id="chart-class"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">By Sector</h3>
        <div class="chart-wrapper" style="height:200px">
          <canvas id="chart-sector"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">By Geography</h3>
        <div class="chart-wrapper" style="height:200px">
          <canvas id="chart-geo"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- HOLDINGS -->
  <section class="section" id="holdings">
    <div class="section-header">
      <span class="section-title">Holdings</span>
      <span class="section-sub">Live prices Daily change</span>
    </div>
    <div class="card" style="padding:0">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Name</th>
              <th class="right">Price</th>
              <th class="right">Daily Chg</th>
              <th class="right">Day Range</th>
              <th class="right">Units</th>
              <th class="right">Value</th>
              <th class="right">Weight</th>
              <th class="right">1Y Return</th>
            </tr>
          </thead>
          <tbody id="holdings-table-body">
          </tbody>
        </table>
      </div>
    </div>
    <div class="section-note">Prices fetched live from quotes cache Daily P&amp;L based on previous close 1Y Return is trailing 12 months</div>
  </section>

  <!-- CORRELATION -->
  <section class="section" id="correlation">
    <div class="section-header">
      <span class="section-title">Correlation Matrix</span>
      <span class="section-sub">252-day rolling Pre-computed</span>
    </div>
    <div class="card">
      <div id="corr-container" style="overflow-x:auto"></div>
      <div class="section-note" style="margin-top:12px">Green = negative correlation (diversification). Red = positive correlation (concentration risk). Diagonal = 1.0 (self).</div>
    </div>
  </section>

  <!-- RISK METRICS -->
  <section class="section" id="risk">
    <div class="section-header">
      <span class="section-title">Risk Metrics</span>
      <span class="section-sub">252-day trailing Pre-computed</span>
    </div>
    <div class="grid-2">
      <div class="card">
        <h3 class="card-title">Return / Risk</h3>
        <div class="metric-row">
          <span class="metric-name">Annualized Return</span>
          <span class="metric-val neg">-4.42%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Annualized Volatility</span>
          <span class="metric-val">20.28%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Sharpe Ratio</span>
          <span class="metric-val">-0.415</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Beta (vs SPY)</span>
          <span class="metric-val">0.649</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">SPY 1Y Return</span>
          <span class="metric-val neg">-8.67%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Alpha vs SPY</span>
          <span class="metric-val pos">+4.25%</span>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">Drawdown / VaR</h3>
        <div class="metric-row">
          <span class="metric-name">Max Drawdown</span>
          <span class="metric-val" style="color:var(--accent-red)">-33.83%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 95% (daily)</span>
          <span class="metric-val">-1.78%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 99% (daily)</span>
          <span class="metric-val">-3.37%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 95% ($)</span>
          <span class="metric-val" id="risk-var95">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">VaR 99% ($)</span>
          <span class="metric-val" id="risk-var99">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">HHI Concentration</span>
          <span class="metric-val">0.3646 <span class="metric-tag tag-warn">HIGH</span></span>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:14px">
      <h3 class="card-title">Risk / Return Scatter</h3>
      <div class="chart-wrapper" style="height:260px">
        <canvas id="chart-risk-scatter"></canvas>
      </div>
    </div>
  </section>

  <!-- PERFORMANCE -->
  <section class="section" id="performance">
    <div class="section-header">
      <span class="section-title">Performance</span>
      <span class="section-sub">252 trading days Feb 2025 to Feb 2026</span>
    </div>
    <div class="card" style="margin-bottom:14px">
      <h3 class="card-title">Portfolio vs SPY (Cumulative Return)</h3>
      <div class="chart-wrapper" style="height:280px">
        <canvas id="chart-perf-main"></canvas>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title">Individual Tickers (Cumulative Return)</h3>
      <div class="chart-wrapper" style="height:300px">
        <canvas id="chart-perf-tickers"></canvas>
      </div>
    </div>
  </section>

  <!-- MONTE CARLO -->
  <section class="section" id="montecarlo">
    <div class="section-header">
      <span class="section-title">Monte Carlo Simulation</span>
      <span class="section-sub">252-day forward projection 10,000 paths</span>
    </div>
    <div class="grid-3" style="margin-bottom:14px">
      <div class="card">
        <div class="stat-label">Prob. of Gain</div>
        <div class="stat-value">38.6%</div>
        <div class="stat-sub">Next 12 months</div>
      </div>
      <div class="card">
        <div class="stat-label">Median Outcome</div>
        <div class="stat-value" id="mc-median-val">-</div>
        <div class="stat-sub" id="mc-median-chg">-</div>
      </div>
      <div class="card">
        <div class="stat-label">90th Pctile Value</div>
        <div class="stat-value" id="mc-p90-val">-</div>
        <div class="stat-sub">Best-case scenario</div>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title">Percentile Fan Chart</h3>
      <div class="chart-wrapper" style="height:320px">
        <canvas id="chart-mc"></canvas>
      </div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>10th Pctile</div>
        <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>25th Pctile</div>
        <div class="legend-item"><div class="legend-dot" style="background:#06b6d4"></div>50th (Median)</div>
        <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div>75th Pctile</div>
        <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div>90th Pctile</div>
      </div>
    </div>
  </section>

  <!-- STRESS TESTS -->
  <section class="section" id="stress">
    <div class="section-header">
      <span class="section-title">Stress Tests</span>
      <span class="section-sub">Recalculated from live prices</span>
    </div>
    <div class="grid-2" id="stress-grid">
    </div>
  </section>

  <!-- FUNDAMENTALS -->
  <section class="section" id="fundamentals">
    <div class="section-header">
      <span class="section-title">Fundamentals</span>
      <span class="section-sub">8 quarters Pre-computed</span>
    </div>
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <span style="font-family:var(--mono);font-size:11px;color:var(--text-secondary)">Ticker:</span>
      <select class="fund-select" id="fund-ticker-select" onchange="renderFundamentals()">
        <option value="NU">NU - Nu Holdings</option>
        <option value="NEE">NEE - NextEra Energy</option>
        <option value="SHECY">SHECY - Shin-Etsu Chemical</option>
        <option value="BAK">BAK - Braskem</option>
        <option value="TSLA">TSLA - Tesla</option>
      </select>
      <span style="font-family:var(--mono);font-size:11px;color:var(--text-secondary)">Metric:</span>
      <select class="fund-select" id="fund-metric-select" onchange="renderFundamentals()">
        <option value="revenue">Revenue ($M)</option>
        <option value="net_income">Net Income ($M)</option>
        <option value="net_margin">Net Margin (%)</option>
        <option value="fcf">Free Cash Flow ($M)</option>
        <option value="total_debt">Total Debt ($M)</option>
        <option value="equity">Equity ($M)</option>
      </select>
    </div>
    <div class="grid-2">
      <div class="card">
        <h3 class="card-title" id="fund-chart-title">Revenue - Nu Holdings</h3>
        <div class="chart-wrapper" style="height:240px">
          <canvas id="chart-fundamentals"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">Key Ratios</h3>
        <div id="fund-ratios-body"></div>
      </div>
    </div>
  </section>

  <!-- YIELD CURVE -->
  <section class="section" id="yield">
    <div class="section-header">
      <span class="section-title">Yield Curve</span>
      <span class="section-sub">US Treasury Pre-computed snapshots</span>
    </div>
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <span style="font-family:var(--mono);font-size:11px;color:var(--text-secondary)">Snapshot:</span>
      <select class="yield-select" id="yield-snapshot-select" onchange="renderYieldCurve()">
      </select>
    </div>
    <div class="card">
      <h3 class="card-title">Yield Curve (US Treasury)</h3>
      <div class="chart-wrapper" style="height:280px">
        <canvas id="chart-yield"></canvas>
      </div>
    </div>
    <div class="card" style="margin-top:14px">
      <h3 class="card-title">All Snapshots (Overlay)</h3>
      <div class="chart-wrapper" style="height:280px">
        <canvas id="chart-yield-all"></canvas>
      </div>
    </div>
  </section>

  <!-- REBALANCING -->
  <section class="section" id="rebalancing">
    <div class="section-header">
      <span class="section-title">Rebalancing</span>
      <span class="section-sub">Live weights vs. targets</span>
    </div>
    <div class="grid-2" style="margin-bottom:14px">
      <div class="card">
        <div class="stat-label">Current HHI</div>
        <div class="stat-value">0.3646</div>
        <div class="stat-sub">High concentration</div>
      </div>
      <div class="card">
        <div class="stat-label">Rebal. Trades Needed</div>
        <div class="stat-value" id="rebal-trades">-</div>
        <div class="stat-sub">To reach ERC target</div>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;gap:20px;margin-bottom:14px;font-family:var(--mono);font-size:10px;color:var(--text-secondary)">
        <div style="display:flex;align-items:center;gap:6px"><div style="width:10px;height:4px;border-radius:2px;background:var(--accent-blue)"></div>Current</div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:10px;height:4px;border-radius:2px;background:var(--accent-green)"></div>ERC Target</div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:10px;height:4px;border-radius:2px;background:var(--accent-orange)"></div>Div. Target</div>
      </div>
      <div id="rebal-rows"></div>
    </div>
    <div class="card" style="margin-top:14px">
      <h3 class="card-title">Weight Comparison</h3>
      <div class="chart-wrapper" style="height:280px">
        <canvas id="chart-rebal"></canvas>
      </div>
    </div>
  </section>

  <!-- INCOME -->
  <section class="section" id="income">
    <div class="section-header">
      <span class="section-title">Income</span>
      <span class="section-sub">Dividend income Recalculated from live prices</span>
    </div>
    <div class="grid-3" style="margin-bottom:16px">
      <div class="card">
        <div class="stat-label">Total Annual Income</div>
        <div class="stat-value" id="income-total">$302</div>
        <div class="stat-sub">From dividends</div>
      </div>
      <div class="card">
        <div class="stat-label">Portfolio Yield</div>
        <div class="stat-value" id="income-yield">0.11%</div>
        <div class="stat-sub" id="income-yield-sub">On total portfolio value</div>
      </div>
      <div class="card">
        <div class="stat-label">Monthly Run Rate</div>
        <div class="stat-value" id="income-monthly">$25</div>
        <div class="stat-sub">Average monthly income</div>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title">Income Breakdown</h3>
      <div id="income-breakdown-table"></div>
      <div class="divider"></div>
      <div class="chart-wrapper" style="height:200px">
        <canvas id="chart-income"></canvas>
      </div>
    </div>
    <div class="section-note">Income is calculated as: Annual Dividend Yield x Current Share Price x Shares Held. Crypto positions (BTC, ETH) and BAK/NU produce no dividends.</div>
  </section>

</main>

<script>
const POSITIONS = {
  BTC:   { units: 2.36693, quoteKey: 'BTCUSD', isCrypto: true },
  ETH:   { units: 2.5088,  quoteKey: 'ETHUSD', isCrypto: true },
  NU:    { units: 2504,    quoteKey: 'NU',      isCrypto: false },
  IEF:   { units: 41,      quoteKey: 'IEF',     isCrypto: false },
  NEE:   { units: 38,      quoteKey: 'NEE',     isCrypto: false },
  SHECY: { units: 143,     quoteKey: 'SHECY',   isCrypto: false },
  BAK:   { units: 1306,    quoteKey: 'BAK',     isCrypto: false },
  TSLA:  { units: 43,      quoteKey: 'TSLA',    isCrypto: false },
  CASH:  { units: 50000,   quoteKey: null,       isCrypto: false },
};

const CASH_VALUE = 50000;

let analytics = null;
let quotes = null;
let isStale = false;
let lastRefresh = null;
let charts = {};

const CGI_BIN = '__CGI_BIN__';
const QUOTES_URL = (CGI_BIN && CGI_BIN !== '__CGI_' + 'BIN__') ? CGI_BIN + '/quotes.py' : './live_quotes.json';

async function loadData() {
  setLoaderStatus('Loading analytics...');
  try {
    const res = await fetch('./analytics.json?' + Date.now());
    analytics = await res.json();
  } catch (e) {
    console.error('Failed to load analytics.json:', e);
    setLoaderStatus('ERROR: Could not load analytics.json');
    return;
  }
  setLoaderStatus('Fetching live quotes...');
  try {
    const res = await fetch(QUOTES_URL + '?' + Date.now());
    const data = await res.json();
    if (data.error || data.stale) {
      console.warn('Quotes stale:', data.error);
      isStale = true;
      quotes = analytics.portfolio.holdings;
    } else {
      quotes = data.quotes;
      isStale = false;
    }
  } catch (e) {
    console.warn('CGI quotes failed, falling back to analytics prices:', e);
    isStale = true;
    quotes = {};
    for (const [t, h] of Object.entries(analytics.portfolio.holdings)) {
      if (t === 'CASH') continue;
      const pos = Object.values(POSITIONS).find(p => p.quoteKey && (POSITIONS[t] ? POSITIONS[t].quoteKey : t) === p.quoteKey);
      quotes[POSITIONS[t] ? POSITIONS[t].quoteKey || t : t] = { price: h.price, change: 0, changePercent: 0, dayHigh: h.price, dayLow: h.price };
    }
    quotes = {};
    for (const [ticker, pos] of Object.entries(POSITIONS)) {
      if (!pos.quoteKey) continue;
      const h = analytics.portfolio.holdings[ticker];
      if (h) {
        quotes[pos.quoteKey] = { price: h.price, change: 0, changePercent: 0, dayHigh: h.price, dayLow: h.price };
      }
    }
  }
  lastRefresh = new Date();
  setLoaderStatus('Rendering dashboard...');
  await renderAll();
  const overlay = document.getElementById('loading-overlay');
  overlay.classList.add('hidden');
  setTimeout(() => overlay.style.display = 'none', 600);
}

function setLoaderStatus(msg) {
  const el = document.getElementById('loader-status');
  if (el) el.textContent = msg;
}

function getLivePrice(ticker) {
  const pos = POSITIONS[ticker];
  if (!pos || !pos.quoteKey) return null;
  const q = quotes[pos.quoteKey];
  if (!q) return null;
  return q;
}

function getLiveValue(ticker) {
  if (ticker === 'CASH') return CASH_VALUE;
  const q = getLivePrice(ticker);
  if (!q) return analytics.portfolio.holdings[ticker]?.value || 0;
  return q.price * POSITIONS[ticker].units;
}

function calcTotalValue() {
  let total = CASH_VALUE;
  for (const t of Object.keys(POSITIONS)) {
    if (t !== 'CASH') total += getLiveValue(t);
  }
  return total;
}

function calcDailyPnL() {
  let pnl = 0;
  for (const t of Object.keys(POSITIONS)) {
    if (t === 'CASH') continue;
    const q = getLivePrice(t);
    if (!q || !q.change) continue;
    pnl += q.change * POSITIONS[t].units;
  }
  return pnl;
}

async function renderAll() {
  updateTimestamps();
  updateLiveBadge();
  renderOverview();
  renderAllocationCharts();
  renderHoldingsTable();
  renderCorrelation();
  renderRiskMetrics();
  renderPerformance();
  renderMonteCarlo();
  renderStressTests();
  renderFundamentals();
  renderYieldCurve();
  renderRebalancing();
  renderIncome();
}

function updateTimestamps() {
  const analyticsTs = analytics?.computed_at;
  const quotesTs = isStale ? 'STALE' : (lastRefresh ? lastRefresh.toLocaleTimeString() : '-');
  const tsA = document.getElementById('ts-analytics');
  const tsP = document.getElementById('ts-prices');
  if (tsA) tsA.textContent = 'Analytics: ' + (analyticsTs ? analyticsTs.slice(0,10) : '-');
  if (tsP) tsP.textContent = 'Prices: ' + (isStale ? 'STALE' : ('LIVE @ ' + quotesTs));
  const overviewUpdated = document.getElementById('overview-updated');
  if (overviewUpdated) {
    overviewUpdated.textContent = isStale ? 'Stale data - CGI unavailable' : ('Prices as of: ' + quotesTs);
  }
  const staleBanner = document.getElementById('stale-banner');
  if (staleBanner) {
    if (isStale) { staleBanner.classList.add('visible'); } else { staleBanner.classList.remove('visible'); }
  }
  startRefreshCountdown();
}

let countdownInterval = null;
function startRefreshCountdown() {
  if (countdownInterval) clearInterval(countdownInterval);
  let secs = 300;
  const el = document.getElementById('ts-refresh');
  function tick() {
    if (!el) return;
    if (secs <= 0) { secs = 300; refreshPrices(); }
    const m = Math.floor(secs / 60), s = secs % 60;
    el.textContent = 'Next refresh: ' + m + 'm' + (s > 0 ? ' ' + s + 's' : '');
    secs--;
  }
  tick();
  countdownInterval = setInterval(tick, 1000);
}

function updateLiveBadge() {
  const badge = document.getElementById('live-badge');
  const badgeText = document.getElementById('live-badge-text');
  if (!badge) return;
  if (isStale) {
    badge.classList.add('stale');
    if (badgeText) badgeText.textContent = 'STALE';
  } else {
    badge.classList.remove('stale');
    if (badgeText) badgeText.textContent = 'LIVE';
  }
}

async function refreshPrices() {
  try {
    const res = await fetch(QUOTES_URL + '?' + Date.now());
    const data = await res.json();
    if (!data.error && !data.stale) { quotes = data.quotes; isStale = false; } else { isStale = true; }
  } catch { isStale = true; }
  lastRefresh = new Date();
  updateTimestamps();
  updateLiveBadge();
  renderOverview();
  renderHoldingsTable();
  renderStressTests();
  renderRebalancing();
  renderIncome();
}

function fmt$(v, d=0)  { return '$' + v.toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d}); }
function fmtPct(v, d=2){ return (v >= 0 ? '+' : '') + v.toFixed(d) + '%'; }
function fmtChg(v)     { return v >= 0 ? '<span class="pos">up ' + fmtPct(v) + '</span>' : '<span class="neg">dn ' + fmtPct(Math.abs(v)) + '</span>'; }
function colorClass(v) { return v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu'; }

function renderOverview() {
  const totalVal = calcTotalValue();
  const invested = analytics.portfolio.total_invested;
  const totalReturn = ((totalVal - invested) / invested * 100);
  const dailyPnl = calcDailyPnL();
  const dailyPct = (dailyPnl / (totalVal - dailyPnl)) * 100;
  const cashWeight = (CASH_VALUE / totalVal * 100).toFixed(1);
  const el = (id) => document.getElementById(id);
  el('stat-total-value').textContent = fmt$(totalVal);
  el('stat-invested').textContent = 'Invested: ' + fmt$(invested);
  const retEl = el('stat-total-return');
  retEl.className = 'stat-change ' + colorClass(totalReturn);
  retEl.textContent = fmtPct(totalReturn) + ' total return';
  const pnlEl = el('stat-daily-pnl');
  pnlEl.style.color = dailyPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  pnlEl.textContent = (dailyPnl >= 0 ? '+' : '') + fmt$(dailyPnl, 0);
  el('stat-daily-pct').textContent = (dailyPnl >= 0 ? '+' : '') + dailyPct.toFixed(2) + '% today';
  el('stat-cash-weight').textContent = 'Weight: ' + cashWeight + '%';
  const var95 = totalVal * 0.01781;
  const var99 = totalVal * 0.0337;
  el('var95-dollar').textContent = fmt$(var95, 0);
  el('var99-dollar').textContent = fmt$(var99, 0);
}

function renderAllocationCharts() {
  const totalVal = calcTotalValue();
  const cryptoVal = getLiveValue('BTC') + getLiveValue('ETH');
  const equityVal = getLiveValue('NU') + getLiveValue('NEE') + getLiveValue('SHECY') + getLiveValue('BAK') + getLiveValue('TSLA');
  const fiVal = getLiveValue('IEF');
  const byClass = { labels: ['Crypto', 'Equities', 'Fixed Income', 'Cash'], values: [cryptoVal, equityVal, fiVal, CASH_VALUE], colors: ['#06b6d4', '#3b82f6', '#10b981', '#8b5cf6'] };
  const bySector = { labels: ['Cryptocurrency', 'Financial Services', 'Consumer Cyclical', 'Utilities', 'Basic Materials', 'Fixed Income', 'Cash'], values: [cryptoVal, getLiveValue('NU'), getLiveValue('TSLA'), getLiveValue('NEE'), getLiveValue('SHECY') + getLiveValue('BAK'), fiVal, CASH_VALUE], colors: ['#06b6d4','#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#4a5568'] };
  const byGeo = { labels: ['Global (Crypto)', 'Brazil', 'US', 'Japan', 'Cash'], values: [cryptoVal, getLiveValue('NU') + getLiveValue('BAK'), getLiveValue('IEF') + getLiveValue('NEE') + getLiveValue('TSLA'), getLiveValue('SHECY'), CASH_VALUE], colors: ['#06b6d4','#10b981','#3b82f6','#ef4444','#8b5cf6'] };
  const donutOpts = (data) => ({ type: 'doughnut', data: { labels: data.labels, datasets: [{ data: data.values, backgroundColor: data.colors, borderColor: '#07070e', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, padding: 8, boxWidth: 10 } }, tooltip: { callbacks: { label: (ctx) => ' $' + ctx.raw.toLocaleString('en-US', {maximumFractionDigits:0}) + ' (' + (ctx.raw/totalVal*100).toFixed(1) + '%)' } } }, cutout: '60%' } });
  destroyChart('chart-class');
  destroyChart('chart-sector');
  destroyChart('chart-geo');
  charts['chart-class']  = new Chart(document.getElementById('chart-class'), donutOpts(byClass));
  charts['chart-sector'] = new Chart(document.getElementById('chart-sector'), donutOpts(bySector));
  charts['chart-geo']    = new Chart(document.getElementById('chart-geo'), donutOpts(byGeo));
}

function renderHoldingsTable() {
  const totalVal = calcTotalValue();
  const body = document.getElementById('holdings-table-body');
  if (!body) return;
  const holdingInfo = {
    BTC:   { name: 'Bitcoin',                category: 'crypto', yr: -20.38 },
    ETH:   { name: 'Ethereum',               category: 'crypto', yr: -14.62 },
    NU:    { name: 'Nu Holdings',            category: 'equity', yr: 33.19  },
    IEF:   { name: 'iShares 7-10Y Treasury', category: 'fi',     yr: 2.77   },
    NEE:   { name: 'NextEra Energy',         category: 'equity', yr: 30.98  },
    SHECY: { name: 'Shin-Etsu Chemical',     category: 'equity', yr: 23.06  },
    BAK:   { name: 'Braskem',               category: 'equity', yr: -10.05 },
    TSLA:  { name: 'Tesla',                 category: 'equity', yr: 39.42  },
    CASH:  { name: 'Cash (USD)',             category: 'cash',   yr: 0      },
  };
  let rows = '';
  for (const [ticker, info] of Object.entries(holdingInfo)) {
    let price = '-', changePct = 0, change$ = 0, dayHigh = '-', dayLow = '-';
    let value, units;
    if (ticker === 'CASH') {
      value = CASH_VALUE; units = '-'; price = '$1.00'; changePct = 0; dayHigh = '-'; dayLow = '-';
    } else {
      units = POSITIONS[ticker].units;
      const q = getLivePrice(ticker);
      if (q) {
        price = q.price >= 100 ? fmt$(q.price, 2) : '$' + q.price.toFixed(4);
        changePct = q.changePercent || 0;
        change$ = q.change || 0;
        dayHigh = q.dayHigh ? fmt$(q.dayHigh, 2) : '-';
        dayLow  = q.dayLow  ? fmt$(q.dayLow, 2)  : '-';
        value = q.price * units;
      } else {
        const h = analytics.portfolio.holdings[ticker];
        price = h ? fmt$(h.price, 2) : '-';
        value = h ? h.value : 0;
        changePct = 0;
      }
    }
    const weight = (value / totalVal * 100).toFixed(1);
    const changeHtml = ticker === 'CASH' ? '<span class="neu">-</span>' : fmtChg(changePct);
    const yr1Html = info.yr >= 0 ? '<span class="pos">+' + info.yr.toFixed(2) + '%</span>' : '<span class="neg">' + info.yr.toFixed(2) + '%</span>';
    const badgeClass = info.category === 'crypto' ? 'ticker-badge crypto' : 'ticker-badge';
    const barWidth = Math.min(weight * 1.2, 60);
    const unitsDisplay = ticker === 'CASH' ? '-' : (units >= 1 ? units.toLocaleString('en-US', {maximumFractionDigits:5}) : units.toFixed(5));
    let rangeDisplay = '-';
    if (ticker !== 'CASH' && dayHigh !== '-' && dayLow !== '-') { rangeDisplay = dayLow + ' - ' + dayHigh; }
    rows += '<tr><td><span class="' + badgeClass + '">' + ticker + '</span></td><td style="color:var(--text-secondary)">' + info.name + '</td><td class="right" style="font-weight:500">' + price + '</td><td class="right">' + changeHtml + '</td><td class="right" style="font-size:10px;color:var(--text-muted)">' + rangeDisplay + '</td><td class="right" style="color:var(--text-secondary)">' + unitsDisplay + '</td><td class="right" style="font-weight:500">' + fmt$(value, 0) + '</td><td class="right"><div class="bar-cell" style="justify-content:flex-end"><div class="weight-bar" style="width:' + barWidth + 'px;' + (info.category==='crypto'?'background:var(--accent-cyan)':'') + '"></div><span>' + weight + '%</span></div></td><td class="right">' + yr1Html + '</td></tr>';
  }
  body.innerHTML = rows;
}

function renderCorrelation() {
  const corr = analytics.correlation;
  const n = corr.labels.length;
  const container = document.getElementById('corr-container');
  if (!container) return;
  const cellSize = Math.min(Math.floor((container.offsetWidth || 600) / (n + 1)), 56);
  let html = '<div class="corr-grid" style="grid-template-columns: ' + cellSize + 'px repeat(' + n + ', ' + cellSize + 'px)">';
  html += '<div style=""></div>';
  for (const lbl of corr.labels) {
    html += '<div style="display:flex;align-items:flex-end;justify-content:center;padding:4px 2px;font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);letter-spacing:0.5px">' + lbl + '</div>';
  }
  for (let i = 0; i < n; i++) {
    html += '<div style="display:flex;align-items:center;padding-right:6px;font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);justify-content:flex-end">' + corr.labels[i] + '</div>';
    for (let j = 0; j < n; j++) {
      const v = corr.matrix[i][j];
      const r = corrColor(v);
      const textColor = Math.abs(v) > 0.4 ? '#fff' : '#aaa';
      const title = corr.labels[i] + ' vs ' + corr.labels[j] + ': ' + v.toFixed(3);
      html += '<div class="corr-cell" title="' + title + '" style="background:' + r + ';color:' + textColor + ';height:' + cellSize + 'px">' + v.toFixed(2) + '</div>';
    }
  }
  html += '</div>';
  container.innerHTML = html;
}

function corrColor(v) {
  if (v >= 0.95) return '#1a0000';
  if (v >= 0) {
    const t = v;
    const r = Math.round(30  + t * 225);
    const g = Math.round(0);
    const b = Math.round(0);
    return 'rgba(' + r + ',' + g + ',' + b + ',' + (0.2 + t*0.7) + ')';
  } else {
    const t = -v;
    const r = Math.round(0);
    const g = Math.round(100 + t * 80);
    const b = Math.round(100 + t * 80);
    return 'rgba(' + r + ',' + g + ',' + b + ',' + (0.15 + t*0.6) + ')';
  }
}

function renderRiskMetrics() {
  const totalVal = calcTotalValue();
  const var95 = fmt$(totalVal * 0.01781, 0);
  const var99 = fmt$(totalVal * 0.0337, 0);
  const e = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  e('risk-var95', var95);
  e('risk-var99', var99);
  const scatterData = [
    { label: 'BTC',   x: 72, y: -20.38, r: 12, color: '#06b6d4' },
    { label: 'ETH',   x: 80, y: -14.62, r: 4,  color: '#3b82f6' },
    { label: 'NU',    x: 42, y: 33.19,  r: 9,  color: '#10b981' },
    { label: 'IEF',   x: 6,  y: 2.77,   r: 3,  color: '#8b5cf6' },
    { label: 'NEE',   x: 18, y: 30.98,  r: 3,  color: '#10b981' },
    { label: 'SHECY', x: 22, y: 23.06,  r: 3,  color: '#f59e0b' },
    { label: 'BAK',   x: 48, y: -10.05, r: 4,  color: '#ef4444' },
    { label: 'TSLA',  x: 68, y: 39.42,  r: 5,  color: '#10b981' },
    { label: 'PORT',  x: 20.28, y: -4.42, r: 8, color: '#06b6d4' },
    { label: 'SPY',   x: 14, y: -8.67,  r: 6,  color: '#4a5568' },
  ];
  destroyChart('chart-risk-scatter');
  charts['chart-risk-scatter'] = new Chart(document.getElementById('chart-risk-scatter'), {
    type: 'bubble',
    data: { datasets: scatterData.map(d => ({ label: d.label, data: [{ x: d.x, y: d.y, r: d.r }], backgroundColor: d.color + '60', borderColor: d.color, borderWidth: 1.5 })) },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => ' ' + ctx.dataset.label + ': vol=' + ctx.parsed.x.toFixed(1) + '%, ret=' + ctx.parsed.y.toFixed(1) + '%' } } }, scales: { x: { title: { display: true, text: 'Annualized Volatility (%)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 10 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, grid: { color: '#1e1e35' } }, y: { title: { display: true, text: '1Y Return (%)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 10 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => v + '%' }, grid: { color: '#1e1e35' } } } }
  });
}

function renderPerformance() {
  const perf = analytics.performance;
  const step = 5;
  const labels = perf.dates.filter((_, i) => i % step === 0);
  const downsample = arr => arr.filter((_, i) => i % step === 0).map(v => ((v - 1) * 100).toFixed(2));
  destroyChart('chart-perf-main');
  charts['chart-perf-main'] = new Chart(document.getElementById('chart-perf-main'), {
    type: 'line',
    data: { labels, datasets: [ { label: 'Portfolio', data: downsample(perf.portfolio), borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.08)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0 }, { label: 'SPY', data: downsample(perf.spy), borderColor: '#4a5568', backgroundColor: 'transparent', borderWidth: 1.5, borderDash: [4,3], fill: false, tension: 0.3, pointRadius: 0 } ] },
    options: lineOpts('%', 'Cumulative Return (%)')
  });
  const tickerColors = { BTC: '#06b6d4', ETH: '#3b82f6', NU: '#10b981', IEF: '#8b5cf6', NEE: '#f59e0b', SHECY: '#ec4899', BAK: '#ef4444', TSLA: '#f97316' };
  destroyChart('chart-perf-tickers');
  charts['chart-perf-tickers'] = new Chart(document.getElementById('chart-perf-tickers'), {
    type: 'line',
    data: { labels, datasets: Object.entries(perf.tickers).map(([t, arr]) => ({ label: t, data: downsample(arr), borderColor: tickerColors[t] || '#888', backgroundColor: 'transparent', borderWidth: 1.5, tension: 0.3, pointRadius: 0, fill: false })) },
    options: lineOpts('%', 'Cumulative Return (%)')
  });
}

function lineOpts(suffix, yLabel) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { labels: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, boxWidth: 12, padding: 12 } },
      tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#8892a4', titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + ctx.parsed.y + suffix } }
    },
    scales: {
      x: { ticks: { color: '#4a5568', font: { family: 'JetBrains Mono', size: 8 }, maxTicksLimit: 8, maxRotation: 0 }, grid: { color: '#1e1e35' } },
      y: { title: { display: true, text: yLabel, color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => v + suffix }, grid: { color: '#1e1e35' } }
    }
  };
}

function renderMonteCarlo() {
  const mc = analytics.monte_carlo;
  const totalVal = calcTotalValue();
  const step = 4;
  const labels = mc.days.filter((_, i) => i % step === 0);
  const ds = arr => arr.filter((_, i) => i % step === 0);
  const medVal = totalVal * (1 + mc.pct_50[mc.pct_50.length - 1] / 100);
  const p90Val = totalVal * (1 + mc.pct_90[mc.pct_90.length - 1] / 100);
  const e = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  e('mc-median-val', fmt$(medVal, 0));
  e('mc-median-chg', fmtPct(mc.pct_50[mc.pct_50.length-1]) + ' from today');
  e('mc-p90-val', fmt$(p90Val, 0));
  destroyChart('chart-mc');
  charts['chart-mc'] = new Chart(document.getElementById('chart-mc'), {
    type: 'line',
    data: { labels, datasets: [
      { label: '10th Pctile', data: ds(mc.pct_10), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.04)',  borderWidth: 1.5, tension: 0.4, fill: false, pointRadius: 0 },
      { label: '25th Pctile', data: ds(mc.pct_25), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.04)', borderWidth: 1.5, tension: 0.4, fill: false, pointRadius: 0 },
      { label: '50th (Median)',data: ds(mc.pct_50), borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.08)',  borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0 },
      { label: '75th Pctile', data: ds(mc.pct_75), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.04)', borderWidth: 1.5, tension: 0.4, fill: false, pointRadius: 0 },
      { label: '90th Pctile', data: ds(mc.pct_90), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.06)', borderWidth: 1.5, tension: 0.4, fill: false, pointRadius: 0 },
    ] },
    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { labels: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, boxWidth: 12, padding: 10 } }, tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#8892a4', titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + (ctx.parsed.y > 0 ? '+' : '') + ctx.parsed.y.toFixed(2) + '%' } } }, scales: { x: { title: { display: true, text: 'Trading Days', color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#4a5568', font: { family: 'JetBrains Mono', size: 8 }, maxTicksLimit: 8 }, grid: { color: '#1e1e35' } }, y: { title: { display: true, text: 'Portfolio Change (%)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => (v > 0 ? '+' : '') + v + '%' }, grid: { color: '#1e1e35' } } } }
  });
}

function renderStressTests() {
  const totalVal = calcTotalValue();
  const btcVal   = getLiveValue('BTC');
  const latamVal = getLiveValue('NU') + getLiveValue('BAK');
  const techVal  = getLiveValue('TSLA') + getLiveValue('NU') + getLiveValue('BTC') * 0.5;
  const ieVal    = getLiveValue('IEF');
  const scenarios = [
    { name: 'BTC -30%',        desc: 'Bitcoin drops 30%',                   newVal: totalVal - btcVal * 0.30,                icon: 'B' },
    { name: 'Rates +100bps',   desc: 'Interest rates rise 100bps',           newVal: totalVal - ieVal * 0.07,                 icon: 'R' },
    { name: 'LatAm Crisis',    desc: 'Latin America selloff (NU, BAK -25%)', newVal: totalVal - latamVal * 0.25,              icon: 'L' },
    { name: 'Tech Crash -25%', desc: 'Technology sector drops 25%',          newVal: totalVal - getLiveValue('TSLA')*0.25,    icon: 'T' },
    { name: 'Global Selloff',  desc: 'All risk assets -20%',                 newVal: totalVal * 0.78 + CASH_VALUE * 0.22,    icon: 'G' },
    { name: 'BTC +50%',        desc: 'Bitcoin rallies 50%',                  newVal: totalVal + btcVal * 0.50,                icon: 'X' },
  ];
  const grid = document.getElementById('stress-grid');
  if (!grid) return;
  grid.innerHTML = scenarios.map(s => {
    const chg = ((s.newVal - totalVal) / totalVal * 100);
    const chgVal = s.newVal - totalVal;
    const isPos = chg >= 0;
    return '<div class="stress-card"><div><div style="font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:1px;color:var(--text-primary);margin-bottom:4px">' + s.name + '</div><div style="font-family:var(--mono);font-size:10px;color:var(--text-muted)">' + s.desc + '</div><div style="font-family:var(--mono);font-size:11px;color:var(--text-secondary);margin-top:6px">New value: ' + fmt$(s.newVal, 0) + '</div></div><div style="text-align:right"><div class="stress-change ' + (isPos ? 'pos' : 'neg') + '">' + fmtPct(chg) + '</div><div style="font-family:var(--mono);font-size:11px;color:' + (isPos?'var(--accent-green)':'var(--accent-red)') + '">' + (isPos ? '+' : '') + fmt$(chgVal, 0) + '</div></div></div>';
  }).join('');
}

let fundChart = null;
function renderFundamentals() {
  const ticker = document.getElementById('fund-ticker-select')?.value || 'NU';
  const metric = document.getElementById('fund-metric-select')?.value || 'revenue';
  const fd = analytics.fundamentals_data.tickers[ticker];
  if (!fd) return;
  const metricLabels = { revenue: 'Revenue ($M)', net_income: 'Net Income ($M)', net_margin: 'Net Margin (%)', fcf: 'Free Cash Flow ($M)', total_debt: 'Total Debt ($M)', equity: 'Equity ($M)' };
  const metricColors = { revenue: '#06b6d4', net_income: '#10b981', net_margin: '#3b82f6', fcf: '#8b5cf6', total_debt: '#ef4444', equity: '#f59e0b' };
  const titleEl = document.getElementById('fund-chart-title');
  const tickerNames = { NU: 'Nu Holdings', NEE: 'NextEra Energy', SHECY: 'Shin-Etsu Chemical', BAK: 'Braskem', TSLA: 'Tesla' };
  if (titleEl) titleEl.textContent = metricLabels[metric] + ' - ' + tickerNames[ticker];
  destroyChart('chart-fundamentals');
  charts['chart-fundamentals'] = new Chart(document.getElementById('chart-fundamentals'), {
    type: metric === 'net_margin' ? 'line' : 'bar',
    data: { labels: fd.quarters, datasets: [{ label: metricLabels[metric], data: fd[metric], backgroundColor: metricColors[metric] + '40', borderColor: metricColors[metric], borderWidth: 2, borderRadius: 3, fill: metric === 'net_margin', tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, titleColor: '#e2e8f0', bodyColor: '#8892a4', callbacks: { label: ctx => ' ' + ctx.parsed.y.toFixed(1) + (metric === 'net_margin' ? '%' : 'M') } } }, scales: { x: { ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, grid: { color: '#1e1e35' } }, y: { ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, grid: { color: '#1e1e35' } } } }
  });
  const ratiosEl = document.getElementById('fund-ratios-body');
  if (!ratiosEl) return;
  const pe = analytics.fundamentals_data.pe_ratios;
  const dy = analytics.fundamentals_data.div_yields;
  const yr = analytics.returns_1y;
  const liveQ = getLivePrice(ticker);
  const liveP = liveQ ? liveQ.price : null;
  const rows = [
    { k: 'P/E Ratio',    v: pe[ticker] ? (pe[ticker] < 0 ? 'N/A (neg. earnings)' : pe[ticker].toFixed(1) + 'x') : '-' },
    { k: 'Div. Yield',   v: dy[ticker] ? dy[ticker].toFixed(2) + '%' : '0.00% (none)' },
    { k: '1Y Return',    v: yr[ticker] !== undefined ? fmtPct(yr[ticker]) : '-' },
    { k: 'Live Price',   v: liveP ? '$' + liveP.toFixed(2) : '-' },
    { k: 'Daily Change', v: liveQ ? fmtPct(liveQ.changePercent) + ' ($' + (liveQ.change >= 0 ? '+' : '') + liveQ.change.toFixed(2) + ')' : '-' },
  ];
  ratiosEl.innerHTML = rows.map(r => '<div class="metric-row"><span class="metric-name">' + r.k + '</span><span class="metric-val">' + r.v + '</span></div>').join('');
}

function renderYieldCurve() {
  const snapshots = analytics.yield_curve.snapshots;
  const sel = document.getElementById('yield-snapshot-select');
  if (sel && sel.options.length === 0) {
    snapshots.forEach((s, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = s.date + (i === snapshots.length - 1 ? ' (Latest)' : '');
      sel.appendChild(opt);
    });
    sel.value = snapshots.length - 1;
  }
  const idx = parseInt(sel?.value || snapshots.length - 1);
  const snap = snapshots[idx];
  destroyChart('chart-yield');
  charts['chart-yield'] = new Chart(document.getElementById('chart-yield'), {
    type: 'line',
    data: { labels: snap.maturities, datasets: [{ label: snap.date, data: snap.yields, borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.08)', borderWidth: 2.5, fill: true, tension: 0.4, pointBackgroundColor: '#06b6d4', pointRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 10 } } }, tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, titleColor: '#e2e8f0', bodyColor: '#8892a4', callbacks: { label: ctx => ' ' + ctx.parsed.y.toFixed(2) + '%' } } }, scales: { x: { ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, grid: { color: '#1e1e35' } }, y: { title: { display: true, text: 'Yield (%)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => v + '%' }, grid: { color: '#1e1e35' } } } }
  });
  const snapColors = ['#4a5568','#6b7280','#8b5cf6','#3b82f6','#06b6d4'];
  destroyChart('chart-yield-all');
  charts['chart-yield-all'] = new Chart(document.getElementById('chart-yield-all'), {
    type: 'line',
    data: { labels: snapshots[0].maturities, datasets: snapshots.map((s, i) => ({ label: s.date, data: s.yields, borderColor: snapColors[i] || '#888', backgroundColor: 'transparent', borderWidth: i === snapshots.length - 1 ? 2.5 : 1.5, borderDash: i === snapshots.length - 1 ? [] : [4, 3], tension: 0.4, fill: false, pointRadius: 3 })) },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, boxWidth: 20, padding: 10 } }, tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, titleColor: '#e2e8f0', bodyColor: '#8892a4', callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + '%' } } }, scales: { x: { ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, grid: { color: '#1e1e35' } }, y: { title: { display: true, text: 'Yield (%)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => v + '%' }, grid: { color: '#1e1e35' } } } }
  });
}

function renderRebalancing() {
  const totalVal = calcTotalValue();
  const rb = analytics.rebalancing;
  const tickers = rb.tickers;
  const liveWeights = tickers.map(t => { const val = getLiveValue(t); return (val / totalVal * 100); });
  const tradesNeeded = tickers.filter((t, i) => Math.abs(liveWeights[i] - rb.erc_target[i]) > 2).length;
  const el = document.getElementById('rebal-trades');
  if (el) el.textContent = tradesNeeded;
  const rowsEl = document.getElementById('rebal-rows');
  if (rowsEl) {
    rowsEl.innerHTML = tickers.map((t, i) => {
      const cw = liveWeights[i];
      const et = rb.erc_target[i];
      const dt = rb.div_target[i];
      const diff = cw - et;
      const diffClass = Math.abs(diff) < 1 ? 'neu' : diff > 0 ? 'neg' : 'pos';
      return '<div class="rebal-row"><div><span class="ticker-badge ' + (['BTC','ETH'].includes(t)?'crypto':'') + '" style="font-size:10px">' + t + '</span><div style="font-family:var(--mono);font-size:9px;color:var(--text-muted);margin-top:3px"><span class="' + diffClass + '">' + (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'pp</span> vs ERC</div></div><div class="rebal-bars"><div class="rebal-bar-row"><span style="width:35px;text-align:right">' + cw.toFixed(1) + '%</span><div class="rebal-bar-track"><div class="rebal-bar-fill bar-current" style="width:' + Math.min(cw*2,100) + '%"></div></div><span style="width:22px;color:var(--accent-blue);font-size:8px">NOW</span></div><div class="rebal-bar-row"><span style="width:35px;text-align:right">' + et.toFixed(1) + '%</span><div class="rebal-bar-track"><div class="rebal-bar-fill bar-erc" style="width:' + Math.min(et*2,100) + '%"></div></div><span style="width:22px;color:var(--accent-green);font-size:8px">ERC</span></div><div class="rebal-bar-row"><span style="width:35px;text-align:right">' + dt.toFixed(1) + '%</span><div class="rebal-bar-track"><div class="rebal-bar-fill bar-div" style="width:' + Math.min(dt*2,100) + '%"></div></div><span style="width:22px;color:var(--accent-orange);font-size:8px">DIV</span></div></div><div style="font-family:var(--mono);font-size:10px;text-align:right;color:var(--text-secondary)">' + fmt$(liveWeights[i]/100 * totalVal, 0) + '</div><div style="font-family:var(--mono);font-size:10px;text-align:right;color:var(--text-muted)">Target: ' + fmt$(et/100 * totalVal, 0) + '</div></div>';
    }).join('');
  }
  destroyChart('chart-rebal');
  charts['chart-rebal'] = new Chart(document.getElementById('chart-rebal'), {
    type: 'bar',
    data: { labels: tickers, datasets: [ { label: 'Current', data: liveWeights.map(v => v.toFixed(1)), backgroundColor: 'rgba(59,130,246,0.5)', borderColor: '#3b82f6', borderWidth: 1.5, borderRadius: 3 }, { label: 'ERC Target', data: rb.erc_target, backgroundColor: 'rgba(16,185,129,0.5)', borderColor: '#10b981', borderWidth: 1.5, borderRadius: 3 }, { label: 'Div Target', data: rb.div_target, backgroundColor: 'rgba(245,158,11,0.5)', borderColor: '#f59e0b', borderWidth: 1.5, borderRadius: 3 } ] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, boxWidth: 12, padding: 10 } }, tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, titleColor: '#e2e8f0', bodyColor: '#8892a4', callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + ctx.parsed.y + '%' } } }, scales: { x: { ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, grid: { color: '#1e1e35' } }, y: { title: { display: true, text: 'Weight (%)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => v + '%' }, grid: { color: '#1e1e35' } } } }
  });
}

function renderIncome() {
  const totalVal = calcTotalValue();
  const inc = analytics.income;
  const liveBreakdown = inc.breakdown.map(item => {
    const q = getLivePrice(item.ticker);
    const livePrice = q ? q.price : (analytics.portfolio.holdings[item.ticker]?.price || 0);
    const liveShares = POSITIONS[item.ticker]?.units || item.shares;
    const liveAnnual = liveShares * item.div_per_share;
    const liveYield = (item.div_per_share / livePrice * 100);
    return { ...item, livePrice, liveAnnual, liveYield: liveYield.toFixed(2) };
  });
  const totalAnnual = liveBreakdown.reduce((a, b) => a + b.liveAnnual, 0);
  const portfolioYield = (totalAnnual / totalVal * 100).toFixed(3);
  const monthly = (totalAnnual / 12).toFixed(0);
  const e = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  e('income-total', fmt$(totalAnnual, 0));
  e('income-yield', portfolioYield + '%');
  e('income-yield-sub', 'On total portfolio (' + fmt$(totalVal, 0) + ')');
  e('income-monthly', fmt$(monthly, 0));
  const tableEl = document.getElementById('income-breakdown-table');
  if (tableEl) {
    tableEl.innerHTML = '<div style="display:grid;grid-template-columns:80px 1fr 80px 80px 80px 80px;gap:0;font-family:var(--mono);font-size:10px"><div style="padding:8px 0;border-bottom:1px solid var(--border);color:var(--text-muted);font-size:9px;letter-spacing:1px">TICKER</div><div style="padding:8px 0;border-bottom:1px solid var(--border);color:var(--text-muted);font-size:9px;letter-spacing:1px">NAME</div><div style="padding:8px 0;border-bottom:1px solid var(--border);color:var(--text-muted);font-size:9px;letter-spacing:1px;text-align:right">SHARES</div><div style="padding:8px 0;border-bottom:1px solid var(--border);color:var(--text-muted);font-size:9px;letter-spacing:1px;text-align:right">DIV/SHR</div><div style="padding:8px 0;border-bottom:1px solid var(--border);color:var(--text-muted);font-size:9px;letter-spacing:1px;text-align:right">ANNUAL</div><div style="padding:8px 0;border-bottom:1px solid var(--border);color:var(--text-muted);font-size:9px;letter-spacing:1px;text-align:right">YIELD</div>' + liveBreakdown.map(b => '<div style="padding:9px 0;border-bottom:1px solid var(--border)"><span class="ticker-badge">' + b.ticker + '</span></div><div style="padding:9px 0;border-bottom:1px solid var(--border);color:var(--text-secondary)">' + b.name + '</div><div style="padding:9px 0;border-bottom:1px solid var(--border);text-align:right">' + b.shares + '</div><div style="padding:9px 0;border-bottom:1px solid var(--border);text-align:right">$' + b.div_per_share.toFixed(3) + '</div><div style="padding:9px 0;border-bottom:1px solid var(--border);text-align:right;color:var(--accent-green)">' + fmt$(b.liveAnnual, 0) + '</div><div style="padding:9px 0;border-bottom:1px solid var(--border);text-align:right">' + b.liveYield + '%</div>').join('') + '<div style="padding:9px 0;grid-column:1/5;font-weight:600;color:var(--text-muted);font-size:9px;letter-spacing:1px">TOTAL</div><div style="padding:9px 0;text-align:right;font-weight:600;color:var(--accent-green)">' + fmt$(totalAnnual, 0) + '</div><div style="padding:9px 0;text-align:right;font-weight:600">' + portfolioYield + '%</div></div>';
  }
  destroyChart('chart-income');
  charts['chart-income'] = new Chart(document.getElementById('chart-income'), {
    type: 'bar',
    data: { labels: liveBreakdown.map(b => b.ticker), datasets: [{ label: 'Annual Income ($)', data: liveBreakdown.map(b => b.liveAnnual.toFixed(0)), backgroundColor: ['#8b5cf660','#10b98160','#06b6d460'], borderColor: ['#8b5cf6','#10b981','#06b6d4'], borderWidth: 2, borderRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0d0d1a', borderColor: '#2a2a50', borderWidth: 1, titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 }, titleColor: '#e2e8f0', bodyColor: '#8892a4', callbacks: { label: ctx => ' $' + ctx.parsed.y + ' annual income' } } }, scales: { x: { ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 10, weight: '600' } }, grid: { color: '#1e1e35' } }, y: { title: { display: true, text: 'Annual Income ($)', color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 } }, ticks: { color: '#8892a4', font: { family: 'JetBrains Mono', size: 9 }, callback: v => '$' + v }, grid: { color: '#1e1e35' } } } }
  });
}

function destroyChart(id) {
  if (charts[id]) { try { charts[id].destroy(); } catch(e) {} delete charts[id]; }
}

function navTo(id) {
  const el = document.getElementById(id);
  const main = document.getElementById('main-content');
  if (el && main) { main.scrollTo({ top: el.offsetTop, behavior: 'smooth' }); }
  document.querySelectorAll('.nav-item').forEach(item => { item.classList.toggle('active', item.dataset.section === id); });
  const sidebar = document.getElementById('sidebar');
  if (sidebar && window.innerWidth <= 768) sidebar.classList.remove('open');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

const mainEl = document.getElementById('main-content');
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const id = entry.target.id;
      document.querySelectorAll('.nav-item').forEach(item => { item.classList.toggle('active', item.dataset.section === id); });
    }
  });
}, { root: mainEl, threshold: 0.3 });

document.querySelectorAll('.section').forEach(s => observer.observe(s));

loadData();
</script>
</body>
</html>
